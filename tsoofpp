import asyncio
import logging
from aiogram.utils.keyboard import ReplyKeyboardBuilder
from aiogram import Bot, Dispatcher, types
from aiogram import F
from aiogram.filters.command import Command
from openpyxl import Workbook, load_workbook
from datetime import datetime
import os

logging.basicConfig(level=logging.INFO)

bot = Bot(token="8008540772:AAEGgdwnePgUsAig8G5ScbQLWQm8dHtivKo")
dp = Dispatcher()

mass = {}
user_selected_product = {}

product_prices = {
    "Товар1": 300,
    "Товар2": 450,
    "Товар3": 520,
    "Товар4": 610,
    "Товар5": 700
}

def save_order_to_excel(user_fullname: str, address: str, cart: dict):
    EXCEL_FILE = "orders.xlsx"

    if not os.path.exists(EXCEL_FILE):
        wb = Workbook()
        ws = wb.active
        ws.title = "Orders"
        ws.append(["Дата", "Имя", "Адрес", "Товар", "Кол-во", "Цена за шт.", "Сумма"])
        wb.save(EXCEL_FILE)
    else:
        wb = load_workbook(EXCEL_FILE)

    ws = wb.active

    for product, amount in cart.items():
        price = product_prices.get(product, 0)
        total = price * amount
        ws.append([
            datetime.now().strftime("%Y-%m-%d %H:%M"),
            user_fullname,
            address,
            product,
            amount,
            price,
            total
        ])

    wb.save(EXCEL_FILE)


@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    builder = ReplyKeyboardBuilder()
    builder.row(
        types.KeyboardButton(text="Корзина"),
        types.KeyboardButton(text="Список товаров")
    )
    await message.answer("Система заказов печатной продукции", reply_markup=builder.as_markup(resize_keyboard=True))


@dp.message(F.text.lower() == "список товаров")
async def show_products(message: types.Message):
    builder = ReplyKeyboardBuilder()
    builder.row(types.KeyboardButton(text="Назад"), types.KeyboardButton(text="Положить в корзину"))
    await message.answer(
        "Список товаров:\n"
        "Товар1 — 300₽\n"
        "Товар2 — 450₽\n"
        "Товар3 — 520₽\n"
        "Товар4 — 610₽\n"
        "Товар5 — 700₽",
        reply_markup=builder.as_markup(resize_keyboard=True)
    )


@dp.message(F.text.lower() == "положить в корзину")
async def choose_product(message: types.Message):
    builder = ReplyKeyboardBuilder()
    builder.row(types.KeyboardButton(text="Товар1"), types.KeyboardButton(text="Товар2"))
    builder.row(types.KeyboardButton(text="Товар3"), types.KeyboardButton(text="Товар4"))
    builder.row(types.KeyboardButton(text="Товар5"))
    await message.answer("Выберите товар:", reply_markup=builder.as_markup(resize_keyboard=True))


@dp.message(F.text.in_(["Товар1", "Товар2", "Товар3", "Товар4", "Товар5"]))
async def add_to_cart(message: types.Message):
    user_selected_product[message.from_user.id] = message.text
    await message.answer(f"Введите количество {message.text}:", reply_markup=types.ReplyKeyboardRemove())


@dp.message(F.text.regexp(r"^\d+$"))
async def get_amount(message: types.Message):
    user_id = message.from_user.id

    if user_id not in user_selected_product:
        return

    product = user_selected_product[user_id]
    amount = int(message.text)

    if product in mass:
        mass[product] += amount
    else:
        mass[product] = amount

    del user_selected_product[user_id]

    price = product_prices.get(product, 0)

    builder = ReplyKeyboardBuilder()
    builder.row(types.KeyboardButton(text="Вернуться к выбору товаров"), types.KeyboardButton(text="Корзина"))

    await message.answer(
        f"{product} x{amount} добавлен в корзину\nЦена: {price}₽  |  Сумма: {price * amount}₽",
        reply_markup=builder.as_markup(resize_keyboard=True)
    )


@dp.message(F.text.lower() == "вернуться к выбору товаров")
async def return_to_products(message: types.Message):
    builder = ReplyKeyboardBuilder()
    builder.row(types.KeyboardButton(text="Товар1"), types.KeyboardButton(text="Товар2"))
    builder.row(types.KeyboardButton(text="Товар3"), types.KeyboardButton(text="Товар4"))
    builder.row(types.KeyboardButton(text="Товар5"))
    await message.answer("Выберите товар:", reply_markup=builder.as_markup(resize_keyboard=True))


@dp.message(F.text.lower() == "корзина")
async def show_cart(message: types.Message):
    builder = ReplyKeyboardBuilder()
    builder.row(types.KeyboardButton(text="Назад"), types.KeyboardButton(text="Заказать"))
    builder.row(types.KeyboardButton(text="Удалить товар"))

    if mass:
        text = "Ваша корзина:\n"
        total_sum = 0
        for name, amount in mass.items():
            price = product_prices[name]
            total = price * amount
            total_sum += total
            text += f"• {name} x{amount} — {price}₽ = {total}₽\n"
        text += f"\nИтого: {total_sum}₽"
    else:
        text = "Ваша корзина пуста."

    await message.answer(text, reply_markup=builder.as_markup(resize_keyboard=True))


@dp.message(F.text.lower() == "заказать")
async def order(message: types.Message):
    await message.answer("Укажите адрес доставки:", reply_markup=types.ReplyKeyboardRemove())


@dp.message(F.text.lower() == "удалить товар")
async def delete_choose(message: types.Message):
    if not mass:
        await message.answer("Корзина пуста.")
        return

    builder = ReplyKeyboardBuilder()
    for name in mass:
        builder.row(types.KeyboardButton(text=f"Удалить {name}"))
    builder.row(types.KeyboardButton(text="Корзина"))

    await message.answer("Выберите товар для удаления:", reply_markup=builder.as_markup(resize_keyboard=True))


@dp.message(F.text.regexp(r"^Удалить (.+)$"))
async def delete_product(message: types.Message):
    product = message.text.replace("Удалить ", "")

    if product in mass:
        del mass[product]
        await message.answer(f"{product} удалён.")
    else:
        await message.answer("Такого товара нет в корзине.")

    await show_cart(message)


@dp.message()
async def catch_address(message: types.Message):
    if "ул" in message.text.lower() or "дом" in message.text.lower() or len(message.text) > 5:
        save_order_to_excel(message.from_user.full_name, message.text, mass.copy())
        mass.clear()

        builder = ReplyKeyboardBuilder()
        builder.row(types.KeyboardButton(text="Корзина"), types.KeyboardButton(text="Список товаров"))

        await message.answer("Ваш заказ сохранён!", reply_markup=builder.as_markup(resize_keyboard=True))
        return

    await message.answer("Некорректный ввод. Попробуйте снова.")


async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
